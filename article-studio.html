<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Stacks — Article Studio (fixed)</title>

<!-- Pull your real article styles for an authentic preview -->
<link rel="stylesheet" href="style.css"/>

<style>
/* Editor UI — intentionally minimal & student-newspaper, not corporate */
:root{
  --ui-bg:#fff;
  --ui-ink:#111;
  --ui-subtle:#666;
  --rule:#d8d8d8;
}
html,body{height:100%}
body{
  margin:0; color:var(--color-text); background:var(--color-bg);
  line-height:1.7; font-family:var(--font-serif);
  display:flex; flex-direction:column;
}
.app{
  display:grid; grid-template-columns: minmax(320px, 520px) 1fr;
  width:100%; max-width:1600px; margin:0 auto; background:transparent;
}
.header{
  grid-column:1 / -1; padding:12px 16px; border-bottom:1px solid var(--rule);
  display:flex; justify-content:space-between; align-items:baseline; gap:1rem;
}
.header h1{ font-family: var(--font-logo, Georgia, serif); font-weight:400; font-size:clamp(1.4rem,2.8vw,1.9rem); margin:0; }
.header .sub{ color:var(--ui-subtle); font-size:.95rem }

.panel{ padding:16px; box-sizing:border-box; }
.left{
  border-right:1px solid var(--rule);
  display:flex; flex-direction:column; gap:14px;
  background:var(--ui-bg);
}
.section{
  border:1px solid var(--rule); padding:12px; background:var(--ui-bg);
}
.section h2{
  font-family: var(--font-sans, Georgia, serif);
  margin:.1rem 0 .4rem 0; font-size:1rem; letter-spacing:.02em; text-transform:uppercase; color:#333;
}
.row{ display:grid; grid-template-columns: 1fr; gap:8px; margin:8px 0; }
.row.two{ grid-template-columns: 1fr 1fr; }
label{ font-size:.9rem; color:#333; display:flex; flex-direction:column; gap:6px; }
input[type="text"], input[type="date"], textarea{
  width:100%; box-sizing:border-box; border:1px solid var(--rule);
  padding:.55rem .6rem; font: inherit; background:#fff; border-radius:2px;
}
textarea{ min-height:150px; resize:vertical; }
.help{ color:var(--ui-subtle); font-size:.9rem; }

.toolbar{ display:flex; gap:6px; flex-wrap:wrap; margin:.25rem 0 .5rem 0; }
button, .btn{
  appearance:none; border:1px solid #000; background:#fff; color:#000;
  font: inherit; padding:.4rem .6rem; cursor:pointer; border-radius:2px;
}
button:hover{ background:#000; color:#fff; }
.btn-quiet{ border-color:var(--rule); color:#222; }
.btn-quiet:hover{ background:#111; color:#fff; }

.drop{
  border:1px dashed #999; padding:10px; text-align:center; cursor:pointer; background:#fafafa;
}
.drop.drag{ outline:2px solid #000; }
.preview-img{ width:100%; max-height:220px; object-fit:cover; border:1px solid var(--rule); background:#f5f5f5; }

.actions{ display:flex; gap:8px; flex-wrap:wrap; }

.right{
  background:#fff; overflow:auto;
}
.preview-frame{
  width:100%; height:calc(100vh - 58px); border:0; display:block; background:#fff;
}

/* Stack on narrow screens */
@media (max-width: 980px){
  .app{ grid-template-columns: 1fr; }
  .left{ border-right:none; border-bottom:1px solid var(--rule); }
  .preview-frame{ height: 70vh; }
}
</style>
</head>
<body>

<div class="app">
  <div class="header">
    <h1>Stacks — Article Studio</h1>
    <div class="sub">Paste copy · drop images · preview &amp; export</div>
  </div>

  <!-- LEFT: editor -->
  <div class="panel left" id="editor">
    <div class="section">
      <h2>front matter</h2>
      <div class="row two">
        <label>section
          <input id="section" type="text" placeholder="e.g., Headlines"/>
        </label>
        <label>date
          <input id="date" type="date"/>
        </label>
      </div>
      <div class="row">
        <label>headline
          <input id="headline" type="text" placeholder="Main headline"/>
        </label>
        <label>sub-headline
          <input id="subhead" type="text" placeholder="Optional sub-headline"/>
        </label>
      </div>
      <div class="row two">
        <label>byline (names only)
          <input id="byline" type="text" placeholder="Your Name"/>
        </label>
        <label>byline separator (optional)
          <input id="bylineSep" type="text" value="By "/>
        </label>
      </div>
    </div>

    <div class="section">
      <h2>feature image</h2>
      <div class="row">
        <div id="featDrop" class="drop" tabindex="0">drop a file here or click to choose</div>
        <input id="featUrl" type="text" placeholder="...or paste image URL (https://)"/>
        <img id="featPreview" class="preview-img" alt="" style="display:none"/>
      </div>
      <div class="row two">
        <label>caption
          <input id="featCap" type="text" placeholder="Photo by …"/>
        </label>
        <label>alt text
          <input id="featAlt" type="text" placeholder="Describe the image for screen readers"/>
        </label>
      </div>
      <div class="help">Tip: Prefer hosted URLs before exporting, so links won’t break.</div>
    </div>

    <div class="section">
      <h2>body text</h2>
      <div class="toolbar">
        <button type="button" class="btn-quiet" data-act="h2">H2</button>
        <button type="button" class="btn-quiet" data-act="quote">Quote</button>
        <button type="button" class="btn-quiet" data-act="img-file">Insert image (file)</button>
        <button type="button" class="btn-quiet" data-act="img-url">Insert image (URL)</button>
        <button type="button" class="btn-quiet" data-act="g2">2-up gallery</button>
        <button type="button" class="btn-quiet" data-act="g3">3-up gallery</button>
      </div>
      <textarea id="body" placeholder="Paste your copy here.

Use:
  ## Heading
  > Quoted line
  ![alt](https://example/image.jpg &quot;Caption text&quot;)
  [GALLERY2](url1|cap1;url2|cap2)
  [GALLERY3](url1|cap1;url2|cap2;url3|cap3)
"></textarea>
    </div>

    <div class="section">
      <h2>actions</h2>
      <div class="actions">
        <button id="btnPreview">Preview</button>
        <button id="btnCopy">Copy article HTML</button>
        <button id="btnDownload">Download full HTML</button>
        <button id="btnSave" class="btn-quiet">Save draft</button>
        <button id="btnLoad" class="btn-quiet">Load draft</button>
        <button id="btnClear" class="btn-quiet">Clear</button>
      </div>
      <div class="help">Preview also updates live as you type.</div>
    </div>

    <div class="section">
      <h2>notes for editors</h2>
      <div class="help">
        • Blank line = new paragraph.  
        • Captions go in quotes in the image syntax.  
        • Galleries take <code>URL|caption</code> pairs separated by semicolons.  
        • After export, replace any <code>blob:</code> URLs with final hosted image URLs.
      </div>
    </div>
  </div>

  <!-- RIGHT: live preview -->
  <div class="panel right">
    <iframe class="preview-frame" id="preview" title="Article preview"></iframe>
  </div>
</div>

<!-- Hidden file inputs for toolbar actions -->
<input id="hiddenFileOne" type="file" accept="image/*" style="display:none"/>
<input id="hiddenFileMany" type="file" accept="image/*" multiple style="display:none"/>

<script>
/* ============ tiny helpers ============ */
const $ = sel => document.querySelector(sel);
const el = (tag, attrs={}) => Object.assign(document.createElement(tag), attrs);

function formatDateHuman(iso){
  if(!iso) return '';
  const d = new Date(iso + 'T12:00:00'); // tz safety
  const months = ["Jan.","Feb.","Mar.","Apr.","May","Jun.","Jul.","Aug.","Sep.","Oct.","Nov.","Dec."];
  const m = months[d.getMonth()];
  const day = String(d.getDate()).padStart(2,'0');
  return `${m} ${day}, ${d.getFullYear()}`;
}

function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

function sanitizeForScript(str){
  return String(str || '').replace(/<\/script/gi, '<\\/script');
}

/* ============ feature image (drop / pick / url) ============ */
const feat = { file:null, url:'', dataUrl:'' };

function handleFeatFile(file){
  feat.file = file;
  const reader = new FileReader();
  reader.onload = e => {
    feat.dataUrl = e.target.result;
    $('#featPreview').src = feat.dataUrl;
    $('#featPreview').style.display = 'block';
    $('#featUrl').value = '';
    liveUpdate();
  };
  reader.readAsDataURL(file);
}

const drop = $('#featDrop');
drop.addEventListener('click', ()=> {
  const input = el('input', {type:'file', accept:'image/*', style:'display:none'});
  input.addEventListener('change', e => {
    const f = e.target.files && e.target.files[0];
    if (f) handleFeatFile(f);
  });
  document.body.appendChild(input); input.click();
  setTimeout(()=> input.remove(), 0);
});
['dragenter','dragover'].forEach(evt => drop.addEventListener(evt, e => {
  e.preventDefault(); e.stopPropagation(); drop.classList.add('drag');
}));
['dragleave','drop'].forEach(evt => drop.addEventListener(evt, e => {
  e.preventDefault(); e.stopPropagation(); drop.classList.remove('drag');
}));
drop.addEventListener('drop', e => {
  const f = e.dataTransfer.files && e.dataTransfer.files[0];
  if (f) handleFeatFile(f);
});

$('#featUrl').addEventListener('input', e=>{
  feat.url = e.target.value.trim();
  if (feat.url){
    $('#featPreview').src = feat.url;
    $('#featPreview').style.display = 'block';
  } else {
    $('#featPreview').style.display = 'none';
  }
  liveUpdate();
});

/* ============ body toolbar ============ */
const bodyTA = $('#body');

function insertAtCursor(textarea, text){
  const start = textarea.selectionStart ?? textarea.value.length;
  const end   = textarea.selectionEnd   ?? textarea.value.length;
  const before = textarea.value.slice(0, start);
  const after  = textarea.value.slice(end);
  textarea.value = before + text + after;
  textarea.focus();
  textarea.selectionStart = textarea.selectionEnd = start + text.length;
}

document.querySelector('.toolbar').addEventListener('click', async (e)=>{
  const act = e.target.dataset.act;
  if (!act) return;
  if (act === 'h2')    insertAtCursor(bodyTA, "\n## Heading\n");
  if (act === 'quote') insertAtCursor(bodyTA, "\n> Quoted line\n");
  if (act === 'img-url'){
    const url = prompt('Image URL (https://)…');
    if (url) insertAtCursor(bodyTA, `\n![alt text](${url} "Caption")\n`);
  }
  if (act === 'img-file'){
    $('#hiddenFileOne').click();
  }
  if (act === 'g2'){ await insertGallery(2); }
  if (act === 'g3'){ await insertGallery(3); }
  liveUpdate();
});

$('#hiddenFileOne').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if (!f) return;
  const dataUrl = await readFileAsDataURL(f);
  insertAtCursor(bodyTA, `\n![alt text](${dataUrl} "Caption")\n`);
  e.target.value = '';
  liveUpdate();
});

async function insertGallery(cols){
  const ok = confirm(`Pick local files for a ${cols}-up gallery? Click “OK”, or “Cancel” to insert a placeholder.`);
  if (ok){
    const files = await pickMany(cols, cols);
    if (!files) return;
    const pairs = await Promise.all(files.map(async f=>{
      const dataUrl = await readFileAsDataURL(f);
      return `${dataUrl}|caption`;
    }));
    insertAtCursor(bodyTA, `\n[GALLERY${cols}](${pairs.join(';')})\n`);
  } else {
    const placeholders = Array.from({length:cols}, ()=> 'https://…|cap').join(';');
    insertAtCursor(bodyTA, `\n[GALLERY${cols}](${placeholders})\n`);
  }
}

function pickMany(min=1, max=4){
  return new Promise(resolve=>{
    const input = $('#hiddenFileMany');
    input.multiple = true;
    input.onchange = ()=>{
      const files = Array.from(input.files || []);
      if (files.length < min || files.length > max) {
        alert(`Please select ${min===max?min:`${min}-${max}`} images.`);
        input.value = '';
        resolve(null);
        return;
      }
      input.value='';
      resolve(files);
    };
    input.click();
  });
}
function readFileAsDataURL(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = e=> resolve(e.target.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

/* ============ parse body (tiny markdown-ish) → article HTML ============ */
function parseBodyToHtml(src){
  let text = src || '';

  // GALLERY2
  text = text.replace(/\[GALLERY2\]\((.*?)\)/g, (_, content)=>{
    const items = content.split(';').map(s=>s.trim()).filter(Boolean).slice(0,2);
    const figs = items.map(pair=>{
      const [url, cap=''] = pair.split('|');
      return `<figure><img src="${url.trim()}" alt="" /><figcaption>${escapeHtml(cap || '')}</figcaption></figure>`;
    }).join('');
    return `\n<div class="photo-duo narrow">${figs}</div>\n`;
  });

  // GALLERY3
  text = text.replace(/\[GALLERY3\]\((.*?)\)/g, (_, content)=>{
    const items = content.split(';').map(s=>s.trim()).filter(Boolean).slice(0,3);
    const figs = items.map(pair=>{
      const [url, cap=''] = pair.split('|');
      return `<figure><img src="${url.trim()}" alt="" /><figcaption>${escapeHtml(cap || '')}</figcaption></figure>`;
    }).join('');
    return `\n<div class="photo-trio narrow">${figs}</div>\n`;
  });

  // Single images
  text = text.replace(/!\[(.*?)\]\((\S+?)(?:\s+"(.*?)")?\)/g, (_, alt, url, cap='')=>{
    return `\n<figure class="figure-embed"><img src="${url}" alt="${escapeHtml(alt||'')}"/><figcaption>${escapeHtml(cap||'')}</figcaption></figure>\n`;
  });

  // Line-by-line parsing
  const lines = text.split(/\r?\n/);
  const out = [];
  let quoteBuf = [];
  let pBuf = [];

  function flushQuote(){
    if (quoteBuf.length){
      const inner = quoteBuf.map(s=>escapeHtml(s.replace(/^>\s?/,'').trim())).join(' ');
      out.push(`<blockquote>${inner}</blockquote>`);
      quoteBuf = [];
    }
  }
  function flushP(){
    if (!pBuf.length) return;
    const paragraph = pBuf.join(' ').trim();
    if (paragraph) out.push(`<p>${escapeHtml(paragraph)}</p>`);
    pBuf = [];
  }

  for (let raw of lines){
    const line = raw.trimEnd();

    if (!line.trim()){
      flushQuote(); flushP();
      continue;
    }
    if (line.startsWith('## ')){
      flushQuote(); flushP();
      out.push(`<h2>${escapeHtml(line.slice(3))}</h2>`);
      continue;
    }
    if (line.startsWith('>')){
      flushP();
      quoteBuf.push(line);
      continue;
    }
    if (line.startsWith('<figure') || line.startsWith('<div class="photo-')){
      flushQuote(); flushP();
      out.push(line);
      continue;
    }
    pBuf.push(line.trim());
  }
  flushQuote(); flushP();

  return out.join('\n');
}

/* ============ build article markup (uses your classes) ============ */
function buildArticle(){
  const section   = $('#section').value.trim();
  const headline = $('#headline').value.trim() || 'Untitled';
  const subhead  = $('#subhead').value.trim();
  const byline   = $('#byline').value.trim();
  const bySep    = $('#bylineSep').value || 'By ';
  const dateISO  = $('#date').value;
  const dateHuman= formatDateHuman(dateISO);

  const featSrc  = feat.dataUrl || feat.url || '';
  const featAlt  = $('#featAlt').value.trim();
  const featCap  = $('#featCap').value.trim();

  const bodyRaw  = $('#body').value;
  const bodyHTML = parseBodyToHtml(bodyRaw);

  const headerHtml = `
  <header class="article-header">
    ${section ? `<div class="article-section">${escapeHtml(section)}</div>` : ''}
    <h1 class="article-headline">${escapeHtml(headline)}</h1>
    ${subhead ? `<h1 class="article-sub-headline">${escapeHtml(subhead)}</h1>` : ''}
    ${byline || dateISO ? `<p class="article-byline">${byline ? `${escapeHtml(bySep)}<strong>${escapeHtml(byline)}</strong>` : ''}${(byline && dateISO)?' &middot; ':''}${dateISO ? `<time datetime="${dateISO}">${dateHuman}</time>` : ''}</p>` : ''}
    ${featSrc ? `
      <figure class="article-featured-image">
        <img src="${featSrc}" alt="${escapeHtml(featAlt)}"/>
        ${featCap ? `<figcaption>${escapeHtml(featCap)}</figcaption>`:''}
      </figure>` : ''}
  </header>`.trim();

  const article = `
<article class="article-full">
  ${headerHtml}
  <section class="article-body">
${bodyHTML}
  </section>
</article>`.trim();

  return article;
}

/* ============ wrap as full document for the iframe (SCRIPT-SAFE) ============ */
function wrapAsDocument(articleHtml){
  const safe = sanitizeForScript(articleHtml);
  return '<!doctype html><html lang="en"><head>'
    + '<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>'
    + '<title>Article — Stacks</title>'
    + '<link rel="stylesheet" href="style.css"/>'
    + '</head><body><div id="main-content" class="visible"><main class="site-main">'
    + safe
    + '</main></div></body></html>';
}

/* ============ live preview (uses srcdoc to avoid document.write quirks) ============ */
const iframe = document.getElementById('preview');

function renderPreview(){
  try{
    const article = buildArticle();
    const doc = wrapAsDocument(article);
    iframe.srcdoc = doc; // safe, simple
  }catch(err){
    console.error('Preview render failed:', err);
  }
}
function liveUpdate(){
  clearTimeout(liveUpdate._t);
  liveUpdate._t = setTimeout(renderPreview, 120);
}

// Input listeners
['section','headline','subhead','byline','bylineSep','date','featCap','featAlt','featUrl','body']
  .forEach(id => { const n = document.getElementById(id); if(n){ n.addEventListener('input', liveUpdate); }});

// Buttons
document.getElementById('btnPreview').addEventListener('click', renderPreview);

document.getElementById('btnCopy').addEventListener('click', ()=>{
  const html = buildArticle();
  navigator.clipboard.writeText(html).then(()=> alert('Article HTML copied to clipboard.'));
});

document.getElementById('btnDownload').addEventListener('click', ()=>{
  const full = wrapAsDocument(buildArticle());
  const blob = new Blob([full], {type:'text/html'});
  const a = el('a', {download: suggestSlug() + '.html', href: URL.createObjectURL(blob)});
  document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
});

document.getElementById('btnSave').addEventListener('click', ()=>{
  const data = {
    section:$('#section').value, headline:$('#headline').value, subhead:$('#subhead').value,
    byline:$('#byline').value, bylineSep:$('#bylineSep').value, date:$('#date').value,
    featAlt:$('#featAlt').value, featCap:$('#featCap').value, featUrl:$('#featUrl').value,
    featData: feat.dataUrl || '', body:$('#body').value
  };
  localStorage.setItem('stacksArticleDraft', JSON.stringify(data));
  alert('Draft saved to this browser.');
});

document.getElementById('btnLoad').addEventListener('click', ()=>{
  const raw = localStorage.getItem('stacksArticleDraft');
  if(!raw) return alert('No draft found.');
  try{
    const d = JSON.parse(raw);
    $('#section').value=d.section||''; $('#headline').value=d.headline||''; $('#subhead').value=d.subhead||'';
    $('#byline').value=d.byline||''; $('#bylineSep').value=d.bylineSep||'By '; $('#date').value=d.date||'';
    $('#featAlt').value=d.featAlt||''; $('#featCap').value=d.featCap||'';
    $('#featUrl').value=d.featUrl||''; if (d.featData){ feat.dataUrl=d.featData; $('#featPreview').src=d.featData; $('#featPreview').style.display='block'; }
    $('#body').value=d.body||'';
    liveUpdate();
  }catch(e){ alert('Could not load draft.'); }
});

document.getElementById('btnClear').addEventListener('click', ()=>{
  if (!confirm('Clear all fields?')) return;
  ['section','headline','subhead','byline','bylineSep','date','featAlt','featCap','featUrl','body'].forEach(id=> document.getElementById(id).value='');
  feat.file=null; feat.url=''; feat.dataUrl=''; $('#featPreview').style.display='none';
  liveUpdate();
});

function suggestSlug(){
  const t = ($('#headline').value || 'article').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
  const d = $('#date').value ? $('#date').value.replace(/-/g,'') : '';
  return (d? d+'-' : '') + t.slice(0,64);
}

// Initial render
renderPreview();
</script>
</body>
</html>

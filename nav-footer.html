<!-- nav-footer.html -->

<!-- ===== DESKTOP NAV ===== -->
<header class="site-header desktop-only" role="banner" aria-label="Site navigation">
  <div id="nav-scroll" class="nav-scroll" aria-label="Primary sections" tabindex="0">
    <!-- Left items -->
    <a href="section-on.html" class="nav-item">On Background</a>
    <a href="section-off.html" class="nav-item">Off the Record</a>
    <a href="section.html" class="nav-item">Notes</a>

    <!-- Center logo (sticky; items scroll “behind” it) -->
    <a class="nav-logo" href="index.html" aria-label="Stacks">
      <img src="stacks-logo-3.png" alt="Stacks">
    </a>

    <!-- Right items -->
    <a href="section.html" class="nav-item">Upcoming Events</a>
    <a href="section.html" class="nav-item">From the Stacks</a>
    <a href="about.html"   class="nav-item">About</a>
  </div>
</header>

<!-- ===== MOBILE NAV ===== -->
<div class="mobile-only" role="banner" aria-label="Mobile navigation">
  <div class="mobile-bar">
    <a class="mobile-logo" href="index.html" aria-label="Stacks">
      <img src="stacks-logo-2.png" alt="Stacks" />
    </a>
    <button id="mobile-menu-toggle" class="mobile-menu-toggle" aria-expanded="false" aria-controls="mobile-menu" aria-label="Toggle menu">
      <span class="line"></span><span class="line"></span><span class="line"></span>
    </button>
  </div>

  <nav id="mobile-menu" class="mobile-menu" aria-label="Mobile menu">
    <a href="section-on.html"  class="nav-item" data-index="0">On Background</a>
    <a href="section-off.html" class="nav-item" data-index="1">Off the Record</a>
    <a href="section.html"     class="nav-item" data-index="2">Notes</a>
    <a href="section.html"     class="nav-item" data-index="3">The Telegraph</a>
    <a href="section.html"     class="nav-item" data-index="4">Upcoming Events</a>
    <a href="section.html"     class="nav-item" data-index="5">Photo Essays</a>
    <a href="section.html"     class="nav-item" data-index="6">From the Stacks</a>
    <a href="about.html"       class="nav-item" data-index="7">About</a>
  </nav>
</div>

<!-- ===== FOLIO ===== -->
<div class="folio" role="contentinfo" aria-label="Folio">
  <div class="folio-inner">
    <div class="folio-left">
      <span id="folio-date" class="folio-item"></span>
    </div>
    <!-- Center group stays perfectly centered under the logo -->
    <div class="folio-center" aria-label="Publication">
      <span class="folio-sep" aria-hidden="true">●</span>
      <a class="folio-item" href="https://daily.org" target="_blank" rel="noopener">The Daily Californian</a>
      <span class="folio-sep" aria-hidden="true">●</span>
    </div>
    <div class="folio-right">
      <span class="folio-item">Issue I</span>
    </div>
  </div>
</div>

<!-- ===== FOOTER ===== -->
<footer class="site-footer-main" id="global-footer" role="contentinfo">
  <div class="footer-inner">
    <!-- Far-most left: spin trigger (15% vw column) -->
    <div class="footer-spin">
      <button class="spin-btn" id="spin-trigger" type="button" aria-label="Spin Mode" title="Spin Mode">
        <!-- set data-duration to your GIF's single-loop length (ms) -->
        <img id="spin-gif"
             src="spiral-still.png"
             data-still="spiral-still.png"
             data-anim="spiral.gif"
             data-duration="1200"
             alt="Spiral" />
      </button>
    </div>

    <!-- Left: 3 equal blocks (60% column) -->
    <div class="footer-left">
      <div class="footer-block" id="block-nextpub">
        <div class="footer-title">Next pub</div>
        <div class="footer-value"><span id="countdown"></span></div>
      </div>

      <div class="footer-block" id="block-time">
        <div class="footer-title" id="time-title">Berkeley, CA</div>
        <div class="footer-value"><span id="berkeley-time">—</span></div>
      </div>

      <div class="footer-block">
        <div class="footer-title">Office</div>
        <div class="footer-value"><span id="coords">37.8715° N, 122.2730° W</span></div>
      </div>
    </div>

    <!-- Right: Stacks books + text (25% column) -->
    <div class="footer-right">
      <img class="footer-books" src="footer-books.gif" alt="Books" />
      <div class="footer-note">&copy; <span id="year"></span> Stacks.</div>
    </div>
  </div>
</footer>

<!-- ===== Minimal scoped CSS that pairs with style.css ===== -->
<style>
  /* Force header links white (belt-and-suspenders) */
  .site-header .nav-scroll .nav-item { color:#fff !important; }
  .site-header .nav-scroll .nav-logo { color:inherit !important; }

  /* Center rail + hide scrollbar chrome */
  .nav-scroll{
    display:flex; align-items:center; gap:28px;
    overflow:auto hidden; scrollbar-width:none;
  }
  .nav-scroll::-webkit-scrollbar{ display:none; }

  /* Logo always dead-center & sized by header height */
  .site-header .nav-logo{
    position: sticky; left:50%; transform:translateX(-50%);
    z-index:2; pointer-events:auto;
  }
  .site-header .nav-logo img{
    display:block; height:calc(var(--header-height) - 10px); width:auto;
  }

  /* FOLIO layout shell only (type & details from style.css) */
  .folio { position:relative; }
  .folio .folio-inner{
    display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:12px;
    max-width:var(--max-width, 1200px); margin:0 auto; padding:8px 16px;
  }
  .folio-left{ text-align:right; white-space:nowrap; }
  .folio-right{ text-align:left; white-space:nowrap; }
  .folio-center{
    display:flex; align-items:center; justify-content:center; gap:.6rem;
    white-space:nowrap;
  }
  .folio-sep{ opacity:.6; }
</style>

<script>
/* ===== Keep footer at bottom ===== */
(function moveFooterToBottom(){
  const f = document.getElementById('global-footer');
  if (f && f.parentElement !== document.body) document.body.appendChild(f);
})();

/* ===== FOLIO DATE ===== */
(function setFolioDate(){
  const el = document.getElementById('folio-date');
  if (!el) return;
  const nowLA = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
  const wd = nowLA.toLocaleString('en-US', { weekday: 'long' });
  const m  = nowLA.toLocaleString('en-US', { month: 'short' });
  const d  = String(nowLA.getDate()).padStart(2,'0');
  const y  = nowLA.getFullYear();
  el.textContent = `${wd}, ${m} ${d}, ${y}`;
})();

/* ===== FOOTER CLOCK + COUNTDOWN ===== */
(function footerInfo(){
  const clockEl   = document.getElementById('berkeley-time');
  const titleEl   = document.getElementById('time-title');
  const cdEl      = document.getElementById('countdown');
  const blockTime = document.getElementById('block-time');
  const blockNext = document.getElementById('block-nextpub');
  const yearEl    = document.getElementById('year');
  if (yearEl) yearEl.textContent = new Date().getFullYear();

  const tz = 'America/Los_Angeles';
  const nowLA = () => new Date(new Date().toLocaleString('en-US',{ timeZone: tz }));

  const fmtClockShort = (d) => {
    const m = d.toLocaleString('en-US', { month: 'short', timeZone: tz });
    const day = String(d.getDate()).padStart(2,'0');
    const t = d.toLocaleString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true, timeZone: tz });
    return `${m} ${day} · ${t}`;
  };

  const addMin = (d, m) => new Date(d.getTime() + m*60000);

  // Next pub: 1st of next month, 9:00am PT (16:00 UTC)
  function nextPubDate(){
    const n = nowLA();
    return new Date(Date.UTC(n.getFullYear(), n.getMonth()+1, 1, 16, 0, 0));
  }
  function fmtCountdown(ms){
    if (ms<=0) return 'Soon';
    const s=Math.floor(ms/1000);
    const d=Math.floor(s/86400);
    const h=Math.floor((s%86400)/3600);
    const m=Math.floor((s%3600)/60);
    const sec=s%60;
    return `${d}d ${String(h).padStart(2,'0')}h ${String(m).padStart(2,'0')}m ${String(sec).padStart(2,'0')}s`;
  }

  let showPlus10 = false;
  let freezeCountdown = false;

  (function clockTick(){
    const base = nowLA();
    const display = showPlus10 ? addMin(base, 10) : base;
    if (clockEl) clockEl.textContent = fmtClockShort(display);
    requestAnimationFrame(clockTick);
  })();

  (function countdownTick(){
    if (!freezeCountdown && cdEl){
      cdEl.textContent = fmtCountdown(nextPubDate().getTime() - Date.now());
    }
    setTimeout(countdownTick, 1000);
  })();

  // Hover/tap interactions
  const prefersTouch = matchMedia('(hover: none)').matches;

  function handleTimeHoverStart(){
    showPlus10 = true;
    if (titleEl) titleEl.textContent = 'BERKELEY TIME';
  }
  function handleTimeHoverEnd(){
    showPlus10 = false;
    if (titleEl) titleEl.textContent = 'Berkeley, CA';
  }
  function handleNextHoverStart(){
    freezeCountdown = true;
    const d = nextPubDate();
    cdEl.textContent = d.toLocaleString('en-US',{
      timeZone: tz, weekday:'short', month:'short', day:'2-digit',
      hour:'numeric', minute:'2-digit'
    });
  }
  function handleNextHoverEnd(){ freezeCountdown = false; }

  if (!prefersTouch){
    blockTime?.addEventListener('mouseenter', handleTimeHoverStart);
    blockTime?.addEventListener('mouseleave', handleTimeHoverEnd);
    blockNext?.addEventListener('mouseenter', handleNextHoverStart);
    blockNext?.addEventListener('mouseleave', handleNextHoverEnd);
  } else {
    blockTime?.addEventListener('click', ()=> {
      showPlus10 = !showPlus10;
      titleEl.textContent = showPlus10 ? 'BERKELEY TIME' : 'Berkeley, CA';
    });
    blockNext?.addEventListener('click', ()=> {
      freezeCountdown = !freezeCountdown;
      if (freezeCountdown) handleNextHoverStart();
    });
  }
})();

/* ===== Desktop nav: center/drag/wheel/nudge ===== */
(function desktopNav(){
  if (!matchMedia('(min-width:1024px)').matches) return;
  const rail = document.getElementById('nav-scroll');
  if (!rail) return;

  function centerRail(){
    const max = rail.scrollWidth - rail.clientWidth;
    rail.scrollLeft = Math.max(0, Math.floor(max/2));
  }

  let ro;
  function onReady(){
    centerRail();
    if (ro) ro.disconnect();
    ro = new ResizeObserver(centerRail);
    ro.observe(rail);
  }
  if (document.readyState === 'complete' || document.readyState === 'interactive') onReady();
  else window.addEventListener('DOMContentLoaded', onReady);

  // Drag to scroll
  let isDown=false, startX=0, startLeft=0;
  rail.addEventListener('mousedown', (e)=>{
    isDown = true; startX = e.pageX; startLeft = rail.scrollLeft;
    rail.classList.add('active-drag');
  });
  ['mouseleave','mouseup'].forEach(evt=>{
    rail.addEventListener(evt, ()=>{ isDown=false; rail.classList.remove('active-drag'); });
  });
  rail.addEventListener('mousemove', (e)=>{
    if(!isDown) return;
    e.preventDefault();
    rail.scrollLeft = startLeft - (e.pageX - startX) * 1.5;
  });

  // Wheel vertical → horizontal
  rail.addEventListener('wheel', (e)=>{
    if (Math.abs(e.deltaY) > Math.abs(e.deltaX)){
      rail.scrollLeft += e.deltaY;
      e.preventDefault();
    }
  }, {passive:false});

  // Keyboard nudges
  rail.addEventListener('keydown', (e)=>{
    if (e.key === 'ArrowRight') rail.scrollLeft += 60;
    if (e.key === 'ArrowLeft')  rail.scrollLeft -= 60;
  });

  // Subtle “nudge” after 5s
  const prefersReduced = matchMedia('(prefers-reduced-motion: reduce)').matches;
  function gentleNudge(){
    if (prefersReduced) return;
    const start = rail.scrollLeft, dist = 80, dur = 900, t0 = performance.now();
    const ease = x => 1 - (1 - x) * (1 - x);
    function step(t){
      const p = Math.min(1, (t - t0)/dur);
      rail.scrollLeft = start + dist*ease(p);
      if (p < 1) requestAnimationFrame(step);
      else {
        setTimeout(()=>{
          const s2 = rail.scrollLeft, backDur = 800, t1 = performance.now();
          function backStep(ti){
            const pb = Math.min(1, (ti - t1)/backDur);
            rail.scrollLeft = s2 - (s2 - start)*ease(pb);
            if (pb < 1) requestAnimationFrame(backStep);
          }
          requestAnimationFrame(backStep);
        }, 700);
      }
    }
    setTimeout(()=>requestAnimationFrame(step), 5000);
  }
  setTimeout(gentleNudge, 5000);
})();

/* ===== Mobile dropdown ===== */
(function mobileNav(){
  if (!matchMedia('(max-width:1023px)').matches) return;
  const btn  = document.getElementById('mobile-menu-toggle');
  const menu = document.getElementById('mobile-menu');
  if (!btn || !menu) return;

  btn.addEventListener('click', ()=>{
    const open = menu.classList.toggle('open');
    btn.setAttribute('aria-expanded', open ? 'true' : 'false');
    btn.classList.toggle('active', open);
    if (open){
      menu.querySelectorAll('a').forEach((a,i)=>{
        a.style.animationDelay = `${i*60}ms`;
        a.classList.remove('plopped'); void a.offsetWidth; a.classList.add('plopped');
      });
    }
  });
})();

/* ===== SPIN SITE + play GIF once ===== */
(function spinEverything(){
  const trigger = document.getElementById('spin-trigger');
  const img = document.getElementById('spin-gif');
  if (!trigger || !img) return;

  function spinSiteOnce(){
    const root = document.documentElement;
    if (root.classList.contains('spin-once-anim')) return;
    root.classList.add('spin-once-anim');
    function cleanup(){ root.classList.remove('spin-once-anim'); root.removeEventListener('animationend', cleanup); }
    root.addEventListener('animationend', cleanup, { once: true });
  }

  function playGifOnce(){
    const still = img.getAttribute('data-still') || img.src;
    const anim  = img.getAttribute('data-anim')  || img.src;
    const durMs = parseInt(img.getAttribute('data-duration') || '1200', 10);
    img.src = `${anim}?t=${Date.now()}`; // restart GIF
    setTimeout(()=>{ img.src = still; }, durMs);
  }

  trigger.addEventListener('click', (e)=>{
    e.preventDefault();
    playGifOnce();
    spinSiteOnce();
  });
})();
</script>
